start
  = headline
    description
    step+

headline "headline starting with ="
  = "=" _ string ___
  
description "description surrounded by ===="
  = "====" ___
    descriptionlines
  	"====" ___ 

descriptionlines
  = descriptionline+ { return { "descriptionlines": text()}; }
  
descriptionline
  = !"====" string __ 
  
step
  = (
      blockmarker ___
      stepinner
      steptextafterlines
      blockmarker __
    )
  / stepinner
  
stepinner
  = !"====" steptextlines?
    "[step]" ___
    stepstitle?
    "--" ___
    steplines
    "--" __

blockmarker "===="
  = "===="

stepstitle
  = "==" _ string __

steptextlines
  = steptextline* { return { "steptextlines": text()}; }

steptextline
  = !"[step]" string __
  
steptextafterlines
  = steptextafterline* { return { "steptextafterlines": text()}; }

steptextafterline
  = !"====" !"[step]" string __
 
steplines
  = stepline+ { return { "steplines": text()}; }
  
stepline
  = function __

function "function call"
  = [^\r\n(]+[(][^\r\n)]*[)] { return text(); }

string "string"
  = [^\r\n]+ { return text(); }

_ "whitespace"
  = [ \t]*
 
__ "linebreak"
  = [ \t\n\r]*
  
___ "linebreak"
  = [ \t\n\r]+